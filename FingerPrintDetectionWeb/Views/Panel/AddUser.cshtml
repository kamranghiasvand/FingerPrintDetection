@using FingerPrintDetectionModel
@using FingerPrintDetectionWeb.Models
@using Microsoft.AspNet.Identity.Owin
@model dynamic
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

}
@functions{

    IEnumerable<PlanViewModel> GetPlanList()
    {
        var res = new List<PlanViewModel>();
        try
        {
            using (var context = ViewContext.HttpContext.GetOwinContext().Get<ApplicationDbContext>())
            {
                res.AddRange(from item in context.Plans
                             where !item.Deleted && item.Users.Count < item.MaxNumberOfUse
                             select new PlanViewModel
                             {
                                 Description = item.Description,
                                 Id = item.Id,
                                 Name = item.Name,
                                 RepeatNumber = item.RepeatNumber,
                                 UserCount = item.Users.Count
                             });
            }
        }
        catch
        {
            // ignored
        }
        return res;
    }

    IEnumerable<string> GetRole()
    {
        var res = new List<string>();
        try
        {
            using (var context = ViewContext.HttpContext.GetOwinContext().Get<ApplicationDbContext>())
            {
                res.AddRange(from item in context.Roles where !item.Deleted select item.Name);
            }
        }
        catch
        {
            // ignored
        }
        return res;
    }

}
<div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title">
            <a href="javascript:void(0);" class="toggle-sidebar">
                <span class="fa fa-angle-double-left" data-toggle="offcanvas" title="Maximize Panel"></span>
            </a> Create Logical User
        </h3>
    </div>
    <div class="panel-body">
        <div class="row">
            <div id="AddRuleFormErrorList" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 validation-summary-errors hidden" style="color: red;" data-valmsg-summary="true">
            </div>
        </div>
        <form role="form" id="addUserForm" enctype="multipart/form-data" data-url="@Url.Action("AddUser", "Panel")">
            <div class="row">
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
                    <div class="form-group required">
                        <label for="UserName" class="control-label">Username</label>
                        <input type="text" class="form-control" id="UserName" placeholder="Username" name="UserName">
                    </div>
                    <div class="form-group required">
                        <label for="email" class="control-label">Email address</label>
                        <input type="email" class="form-control" id="email" name="Email" placeholder="Enter email">
                    </div>
                    <div class="form-group required">
                        <label for="password" class="control-label">Password</label>
                        <input type="password" class="form-control" id="password" name="Password" placeholder="Password">
                    </div>
                    <div class="form-group required">
                        <label for="cfmPassword" class="control-label">Confirm Password</label>
                        <input type="password" class="form-control" name="cfmPassword" id="cfmPassword" placeholder="Password">
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
                    <div class="form-group required">
                        <label for="FirstName" class="control-label">First Name</label>
                        <input type="text" class="form-control" id="FirstName" name="FirstName" placeholder="First Name">
                    </div>
                    <div class="form-group">
                        <label for="lastName" class="control-label">Last Name</label>
                        <input type="text" class="form-control" id="lastName" name="LastName" placeholder="Last Name">
                    </div>
                    <div class="form-group">
                        <label for="SoundTrack">Sound Track</label>
                        <input type="file" id="SoundTrack" name="SoundTrack">
                        <p class="help-block">sound track for play</p>
                    </div>
                    <div class="form-group">
                        <label for="PlanId" class="control-label">Plan</label>
                        <select id="PlanId" name="PlanId" class="selecter_3" required data-selecter-options='{"cover":"true"}'>
                            <option value="-1">Select Plan... </option>
                            @foreach (var item in GetPlanList())
                            {
                                <option value="@item.Id">@item.Name</option>
                            }
                        </select>

                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-default">Add User</button>
        </form>

    </div><!-- panel body -->
</div>
@section scripts{
    <script>
        $("#addUserForm").validate({
            rules: {
                UserName: {
                    required: true,
                    minlength: 6
                },
                password: {
                    required: true,
                    minlength: 6,
                    maxlength: 10
                },

                cfmPassword: {
                    equalTo: "#password",
                    minlength: 6,
                    maxlength: 10
                },
                FirstName: {
                    required: true
                },
                PlanId: {
                    required: true
                }
            },
            messages: {
                password: {
                    required: "the password is required"

                },
                UserName: {
                    required: "the username is required"
                },
                FirstName: {
                    required: "the FirstName is required"
                },
                PlanId: { required: "Please select an item" }

            }

        });
        $('#addUserForm').bind('submit', function (e) {
            var form = $(this);
            var url = form.data('url');
            form.validate();
            var isValid = form.valid();
            if (!isValid) {
                e.preventDefault(); //prevent the default action
                return;
            }
            $('#globalLoadingModal').modal('show');
            $.ajax({
                type: 'POST',
                url: url,
                async: false,
                data: form.serialize(),
                success: function (data) {
                    $('#globalLoadingModal').modal('hide');
                    if (data.status === 'success') {
                        form.find('.validation-summary-errors').addClass('hidden').empty();
                        window.location.href = data.address;
                    } else if (data.status === 'fail') {
                        form.find('.validation-summary-errors').empty().append('<ul class="validation-summary-errors-list"></ul>').removeClass('hidden');
                        for (var cnt = 0; cnt < data.errors.length; cnt++) {
                            form.find('.validation-summary-errors-list').append('<li>' + data.errors[cnt] + '</li>');
                        }

                    }
                    // $("#answers").html(response);
                },
                error: function (errors) {

                    $('#globalLoadingModal').modal('hide');
                }
            });
        });

    </script>
}
